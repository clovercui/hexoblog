<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	 <link rel="shortcut icon" href="/img/logo_miccall.png">
	
			
    <title>
    Clover`S Blog
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/hexoblog/css/mic_main.css" />
    <link rel="stylesheet" href="/hexoblog/css/dropdownMenu.css" />
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/hexoblog/css/noscript.css" />
    </noscript>

			    <script src="/hexoblog/js/jquery.min.js"></script>
    <script src="/hexoblog/js/jquery.scrollex.min.js"></script>
    <script src="/hexoblog/js/jquery.scrolly.min.js"></script>
    <script src="/hexoblog/js/skel.min.js"></script>
    <script src="/hexoblog/js/util.js"></script>
    <script src="/hexoblog/js/main.js"></script>
	
</head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/hexoblog/" class="logo">MICCALL</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/hexoblog/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/hexoblog/categories/开发工具/">开发工具</a></li><li><a class="category-link" href="/hexoblog/categories/技术碎片/">技术碎片</a></li><li><a class="category-link" href="/hexoblog/categories/数据库/">数据库</a></li><li><a class="category-link" href="/hexoblog/categories/示例/">示例</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="简历">
		                简历
		            </a>
		        </li>
		        
		        <li>
		            <a href="/group/" title="团队">
		                团队
		            </a>
		        </li>
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="标签">
		                标签
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		                <li><a href="https://github.com/miccall" class="icon fa-github"><span class="label">GitHub</span></a></li>
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(undefined);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >Monogo DB Study</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h1 id="MonogoDB-学习笔记"><a href="#MonogoDB-学习笔记" class="headerlink" title="MonogoDB  学习笔记"></a>MonogoDB  学习笔记</h1><hr>
<p>#入门篇</p>
<hr>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><hr>
<h4 id="Mongo-概念"><a href="#Mongo-概念" class="headerlink" title="Mongo 概念"></a>Mongo 概念</h4><ul>
<li><code>mongo</code> <code>MongoDB</code> <code>索引</code> <code>集合</code> <code>复制集</code> <code>分片</code> <code>数据均衡</code></li>
</ul>
<h4 id="学会MongoDB的搭建"><a href="#学会MongoDB的搭建" class="headerlink" title="学会MongoDB的搭建"></a>学会MongoDB的搭建</h4><ul>
<li>搭建简单的单击服务</li>
<li>搭建具有冗余容错功能的复制集</li>
<li>搭建大规模数据集群</li>
<li>完成集群的自动部署</li>
</ul>
<h4 id="MongoDB的使用"><a href="#MongoDB的使用" class="headerlink" title="MongoDB的使用"></a>MongoDB的使用</h4><ul>
<li>最基本的文档的读写和更新</li>
<li>各种不同类型的索引的创建与使用</li>
<li>复杂的聚合查询</li>
<li>对数据集合进行分片，在不同分片间维持数据均衡</li>
<li>数据备份与恢复</li>
<li>数据迁移</li>
</ul>
<a id="more"></a>
<h4 id="简单运维"><a href="#简单运维" class="headerlink" title="简单运维"></a>简单运维</h4><ul>
<li>部署集群</li>
<li><p>处理多种常见的故障</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"> 单节点失效，如何恢复工作</div><div class="line"> 数据库意外被杀死如何进行数据恢复</div><div class="line"> 数据库拒绝服务如何排除原因</div><div class="line"> 数据库磁盘快慢时如何处理</div><div class="line"> </div><div class="line"> ``` </div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## 学习资源</div><div class="line">---</div><div class="line">* **MongoDB官网** `www.mongodb.org`</div><div class="line">* **MongoDB中国官网** `www.mongoing.com`</div><div class="line">* **github** `https://github.com/mongodb/mongo`</div><div class="line">* **中文文档** `docs.mongoing.com`</div><div class="line">* **视频资源** `http://www.imooc.com/video/5934`</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">#开始学习</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## 数据库</div><div class="line"></div><div class="line">---</div><div class="line">### 概念</div><div class="line">1. 有组织的存放数据</div><div class="line">2. 按照不同的需求进行查询</div><div class="line"></div><div class="line">### 数据库分类</div><div class="line">1. sql数据库：支持sql语言的数据库 Oracle,Mysql</div><div class="line">2. NoSql数据库：不支持SQL语言的数据库 Redis,MongoDB</div><div class="line"></div><div class="line">Sql 数据库 | NoSql数据库 </div><div class="line">----------|------------- </div><div class="line">实时一致性   	  | 简单便捷 </div><div class="line">事务          |方便扩展</div><div class="line">多表联合查询   | 更好的性能</div><div class="line"></div><div class="line">### 为什么是MongoDB</div><div class="line">1. 无数据结构的限制</div><div class="line">	1. 没有表结构的概念，每条记录可以有完全不同的结构</div><div class="line">	2. 业务开发方便快捷</div><div class="line">	3. sql数据库需要先定义表结构再使用</div></pre></td></tr></table></figure>
<p>  {name:”小明”,sex:”男”}<br>  {name:”小明”,address:”上海”}<br>  {name:”小明”,home:[{“山东”},{“江西”}]}</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2. 完全的索引支持</div><div class="line">	1. redis的key-value</div><div class="line">	2. hbase的单索引	，二级索引需要自己实现</div></pre></td></tr></table></figure>
<p>  单键索引，多键索引：{x:1,y:1}<br>  数组索引：[“apple”,”lemon”]<br>  全文索引：“I am a little bird” (中文)<br>  地理位置索引：2D</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">3. 方便的冗余和扩展</div><div class="line">	1. 复制集保证数据安全</div><div class="line">	2. 分片扩展数据规模</div><div class="line"></div><div class="line">4. 良好的支持</div><div class="line">	1. 完善的文档</div><div class="line">	2. 齐全的驱动支持</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">&gt;安装过程 略过</div><div class="line"></div><div class="line">---</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="mkdir-data"><a href="#mkdir-data" class="headerlink" title="mkdir data"></a>mkdir data</h1><h1 id="mkdir-log"><a href="#mkdir-log" class="headerlink" title="mkdir log"></a>mkdir log</h1><h1 id="mkdir-conf"><a href="#mkdir-conf" class="headerlink" title="mkdir conf"></a>mkdir conf</h1><h1 id="mkdir-bin"><a href="#mkdir-bin" class="headerlink" title="mkdir bin"></a>mkdir bin</h1><h1 id="cd-conf"><a href="#cd-conf" class="headerlink" title="cd conf"></a>cd conf</h1><h1 id="vim-mongodb-conf"><a href="#vim-mongodb-conf" class="headerlink" title="vim mongodb.conf"></a>vim mongodb.conf</h1><p>  port=27017<br>  dbpath=data<br>  logpath=log/mongod.log<br>  fork=true<br>启动 # mongod -f conf/mongodb.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">连接 mongo 121.41.31.214:27017</div><div class="line">数据库的关闭 连接时   db.shutdownServer()</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## mongoDB的基本操作</div><div class="line"></div><div class="line">---</div></pre></td></tr></table></figure></p>
<p>查看所有数据库</p>
<blockquote>
<p>show dbs</p>
</blockquote>
<p>切换数据库</p>
<blockquote>
<p>use dbname</p>
</blockquote>
<p>删除当前数据库,（需要先use）</p>
<blockquote>
<p>db.dropDatabase();</p>
</blockquote>
<p>创建表 (不要特殊创建 只需要use 一个不存在的name mongoDb会在需要的时候自己创建，一个表是一个集合)</p>
<blockquote>
<p>use dbname</p>
</blockquote>
<p>数据的写入  db.集合名.insert(json数据) 表集合不存在的话自动创建 _id自动创建 _id自定义时不能重复</p>
<blockquote>
<p>db.dbname_collection.insert({x:1})</p>
</blockquote>
<p>数据的查询 db.集合名.find()  参数可以为空，返回所有文档</p>
<blockquote>
<p>db.dbname_collection.find()<br>db.dbname_collection.find({x:1})   查询x=1的文档</p>
</blockquote>
<p>循环插入</p>
<blockquote>
<p>for(i=3;i&lt;100;i++)db.dbname_collection.insert({x:i})</p>
</blockquote>
<p>计数</p>
<blockquote>
<p>db.dbname_collection.find().count()</p>
</blockquote>
<p>跳过，限制条数，排序</p>
<blockquote>
<p>db.dbname_collection.find().skip(3).limit(2).sort({x:1})</p>
</blockquote>
<p>数据更新 db.集合名.find(查询条件,更新条目)  默认只会更新第一条找到的数据</p>
<blockquote>
<p>db.dbname_collection.update({x:1},{x:999})  会更新x=1的文档为 {x:999}<br>注意：db.dbname_collection.insert({x:1,y:2,z:3}) 若要更新z=3的文档 把x更新为22， 使用 db.dbname_collection.update({z:3},{x:22})  会把{x:1,y:2,z:3}整体覆盖为{x:22} </p>
</blockquote>
<p>局部更新</p>
<blockquote>
<p>db.dbname_collection.update({z:3},{$set:{x:22}})  局部更新 不会被覆盖</p>
</blockquote>
<p>更新不存在的数据，即自动创建 第三个参数 true 标示不存在的时候自动创建</p>
<blockquote>
<p>db.dbname_collection.update({x:3},{x:22},true)</p>
</blockquote>
<p>批量更新  第四个参数 true 批量更新</p>
<blockquote>
<p>db.dbname_collection.update({x:1},{$set:{x:22}},false,true)</p>
</blockquote>
<p>数据删除  必须传参，默认删除所有找的数据</p>
<blockquote>
<p>db.dbname_collection.remove({x:1})<br>db.dbname_collection.drop()</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## MongoDB索引</div><div class="line"> </div><div class="line">---</div><div class="line"></div><div class="line">#### 内容简介</div><div class="line"></div><div class="line">1. 索引的种类和使用</div><div class="line">2. 索引的匹配规则</div><div class="line">3. 如何建立合适的索引</div><div class="line">4. 索引建立的情况评估</div></pre></td></tr></table></figure>
<p>查看索引</p>
<blockquote>
<p>db.dbname_collection.getIndexes()</p>
</blockquote>
<p>创建索引  参数也是文档  1代表正向排序 -1 代表逆向排序</p>
<blockquote>
<p>db.dbname_collection.ensureIndex({x:1})</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 索引的种类</div><div class="line"></div><div class="line">1. _id索引</div><div class="line">2.  单键索引</div><div class="line">3.  多键索引</div><div class="line">4.  复合索引</div><div class="line">5.  过期索引</div><div class="line">6.  全文索引</div><div class="line">7.  地理位置索引</div><div class="line"></div><div class="line">##### _id索引</div><div class="line">* _id索引是绝大多数集合默认建立的索引</div><div class="line">* 对于每个插入的数据，MongoDB都会自动生成一条唯一的_id字段</div><div class="line"></div><div class="line">##### 单键索引</div><div class="line">* 单键索引是最普通的索引</div><div class="line">* 与_id索引不同，单键索引不会自动创建</div><div class="line"></div><div class="line">##### 多键索引</div><div class="line">* 多键索引与单键索引创建形式相同，区别在于字段的值</div><div class="line">   * 单键索引：值为单一的值，例如字符串，数字或者日期</div><div class="line">   * 多键索引：值具有多个记录，例如数组</div><div class="line">##### 复合索引</div><div class="line">* 当我们的查询条件不只有一个时，就需要建立复合索引</div><div class="line">  * 插入&#123;x:1,y:2,z:3&#125;-&gt;按照x与y的值查询-&gt;创建索引db.collection.ensureIndex(&#123;x:1,y:1&#125;)-&gt;使用&#123;x:1,y:1&#125;作为条件进行查询  </div><div class="line"></div><div class="line">##### 过期索引</div><div class="line">* 过期索引：是在一段时间后会过期的索引</div><div class="line">* 在索引过期后，相应的数据会被删除</div><div class="line">* 这适合存储一些在一些时间后会失效的数据 比如用户的登陆信息，存储的日志  </div><div class="line">* 建立方法：db.collection.ensureIndex(&#123;time:1&#125;,&#123;expireAfterSeconds:10&#125;),第二个参数是过期时间的秒数</div><div class="line">* 过期索引的限制</div><div class="line">	1. 存储在过期索引字段的值必须是指定的时间类型，说明：必须是ISODate或者ISODate数组，不能使用时间戳，否则不能被自动删除</div><div class="line">	2. 如果指定了ISODate数组，则按照最小的时间进行删除</div><div class="line">	3. 过期索引不能是复合索引</div><div class="line">	4. 删除时间是不精确的 说明：删除过程是由后台程序每60S跑一次，而且删除也需要一些时间，所以存在误差</div><div class="line"></div><div class="line">##### 全文索引 </div><div class="line">*  全文索引：对字符串与字符串数组创建全文可搜索的索引</div><div class="line">适用情况&#123;author:&quot;&quot;,title:&quot;&quot;,article:&quot;&quot;&#125;</div><div class="line">* 建立方法</div><div class="line">	db.articles.ensureIndex(&#123;key:&quot;text&quot;&#125;)</div><div class="line">	db.articles.ensureIndex(&#123;key_1:&quot;text&quot;,key_2:&quot;text&quot;&#125;)</div><div class="line">	db.articles.ensureIndex(&#123;&quot;$**&quot;:&quot;text&quot;&#125;)</div><div class="line">* 如何创建全文索引	</div><div class="line">	db.imooc_2.ensureIndex(&#123;&quot;article&quot;:&quot;text&quot;&#125;)</div><div class="line">* 如何使用全文索引进行查询</div><div class="line">	1.	db.articles.find(&#123;$text:&#123;$search:&quot;coffee&quot;&#125;&#125;)</div><div class="line">	2.	db.articles.find(&#123;$text:&#123;$search:&quot;aa bb cc&quot;&#125;&#125;) 查询 aa 或bb 或cc</div><div class="line">	3.	db.articles.find(&#123;$text:&#123;$search:&quot;aa bb -cc&quot;&#125;&#125;) 查询aa 或bb 不包含cc</div><div class="line">	4.	db.articles.find(&#123;$text:&#123;$search:&quot;\&quot;aa\&quot; \&quot;bb\&quot; \&quot;cc\&quot;&quot;&#125;&#125;) 且的关系 既包含aa也包含bb也包含cc</div><div class="line">* 全文索引的相似度</div><div class="line"> </div><div class="line">  $meta操作符：&#123;score:&#123;$meta:&quot;textScore&quot;&#125;&#125;</div><div class="line">  写在查询条件后面可以返回结果的相似度与sort一起使用，可以达到很好的实用效果	db.articles.find(&#123;$text:&#123;$search:&quot;aa bb&quot;&#125;&#125;,&#123;score:&#123;$meta:&quot;tetxScore&quot;&#125;&#125;).sort(&#123;score:&#123;$meta:&quot;tetxScore&quot;&#125;&#125;)</div><div class="line">* 全文索引的使用限制</div><div class="line">  1.每次查询，只能指定一个$text查询</div><div class="line">  2. $test查询不能出现在$nor查询中	</div><div class="line">  3. 查询中如果包含了$test,hint不再起作用</div><div class="line">  很可惜，MongoDB全文索引还不支持中文</div><div class="line"></div><div class="line">#### 索引属性</div><div class="line">1. 创建索引的格式</div><div class="line">	db,collection.ensureIndex(&#123;param&#125;,&#123;param&#125;) </div><div class="line">	其中第二个参数便是索引的属性</div><div class="line">2. 比较重要的属性有 名字 唯一性 稀疏性 是否定时删除</div><div class="line">	* 名字，name指定：db.collection.ensureIndex(&#123;&#125;,&#123;name:&quot;&quot;&#125;)</div><div class="line">	* 唯一性，unique指定：db.collection.ensureIndex(&#123;&#125;,&#123;unique:true/false&#125;)</div><div class="line">	* 稀疏性，sparse指定：db.collection.ensureIndex(&#123;&#125;,&#123;sparse:true/false&#125;) 默认是不稀疏的</div><div class="line">	db.collection.find(&#123;m:&#123;$exists:true&#125;&#125;)查询存在m的文档</div><div class="line">	db.collection.ensureIndex(&#123;m:1&#125;,&#123;sparse:true&#125;)</div><div class="line">	</div><div class="line">	db.collection.find(&#123;m:&#123;$exists:false&#125;&#125;)</div><div class="line">	**在选取索引  在稀疏索引上 查找是否存在 将不使用稀疏索引**</div><div class="line">	强制使用索引 db.collection.find(&#123;m:&#123;$exists:false&#125;&#125;).hint(&quot;m_1&quot;)</div><div class="line">	</div><div class="line">	* 是否定时删除，expireAfterSeconds指定</div><div class="line">	TTL，过期索引</div><div class="line">	 </div><div class="line">##### 地理位置索引 </div><div class="line">* 将一些点的位置存储在MongoDB中，创建索引后，可以按照位置来查找其他点</div><div class="line">  * 子分类:</div><div class="line">  1. 2d索引，用于存储和查找平面上的点。</div><div class="line">  2. 2dsphere索引，用于存储和查找球面上的点</div><div class="line">* 查找方式</div><div class="line">  * 查找距离某个点一定距离的点  </div><div class="line">  * 查找包含在某区域内的点</div></pre></td></tr></table></figure>
<p>2D索引：平面地理位置索引<br>        创建方式:db.collection.ensureIndex({w:”2d”})<br>        位置表示方式：经纬度[经度,维度]<br>        取值范围：经度[-180,180]维度[-90,90]<br>        db.collection.insert({w:[100,2]})<br>        db.collection.find({w:{$near:[1,1]}})<br>        near会返回100个离查询的点最近的点<br>        db.collection.find({w:{$near:[1,1]，$maxDistance:10}})  </p>
<pre><code>    查询方式：
    （1）$near查询：查询距离某个点最近的点
    （2）$geoWithin查询：查询某个形状内的点

    形状的标示：
    1.$box:矩形，使用
    {$box[[&lt;x1&gt;,&lt;y1&gt;],[&lt;x2&gt;,&lt;y2&gt;]]}  1.左边界 2.右边界
    2.$center:圆形，使用
    {$center:[[&lt;x1&gt;,&lt;y1&gt;],r]} 1.圆心位置 2.半径
    3.$polygon:多边形，使用
    {$polygon：[[&lt;x1&gt;,&lt;y1&gt;],[&lt;x2&gt;,&lt;y2&gt;],[&lt;x3&gt;,&lt;y3&gt;]]}

    db.collection.find({w:{$geoWithin:{$box:[[0,0],[3,3]]}}})

geoNear查询
geoNear使用runCommand命令进行使用
{
geoNear:&lt;collection&gt;,
near:[x,y],
minDistance:(对2D索引无效)
MaxDistance:
num:
}

db.runCommand({geoNear:&quot;location&quot;,near:[1,2],maxDistance:10,num:1})
</code></pre><p>2dsphere:<br>创建方式:db.collection.ensureIndex({w:”2dsphere”})<br>位置表示方式<br>GeoJson:描述一个点，一条直线，多边形等<br>格式：{type:””,coordinates:[<coordinates>]}<br>查询方式和2D索引查询方式类似<br>支持$minDistance与$maxDistance</coordinates></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## 索引构建情况分析</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">* 索引好处：加快索引相关的查询</div><div class="line">* 索引不好处：增加磁盘空间消耗，降低写入性能</div><div class="line"></div><div class="line">---</div><div class="line">* 如何评判当前索引构建情况</div><div class="line">	1. mongostat工具介绍</div><div class="line">	2. profile集合介绍</div><div class="line">	3. 日志介绍</div><div class="line">	4. explain分析</div><div class="line"></div><div class="line">##### mongostat工具</div><div class="line"> * mongostat查看mongodb运行状态的程序</div><div class="line"> * 使用说明	:mongostat -h 127.0.0.1:12345</div><div class="line"> </div><div class="line"> * 字段说明:</div><div class="line"> 	* inserts</div><div class="line"> 	* query</div><div class="line"> 	* update</div><div class="line"> 	* delete</div><div class="line"> 	* getmore</div><div class="line"> 	* command</div><div class="line"> 	* flushes</div><div class="line"> 	* mapped</div><div class="line"> 	* vsize</div><div class="line"> 	* res</div><div class="line"> 	* non-mapped</div><div class="line"> 	* faults</div><div class="line"> 	* locked</div><div class="line"> 	* idx miss 索引情况</div><div class="line"> 	* qr|qw</div><div class="line"> 	* ar|aw</div><div class="line"> 	* netIn</div><div class="line"> 	* netOut</div><div class="line"> 	* conn</div><div class="line"> 	* set</div><div class="line"> 	* repl</div><div class="line"> 	</div><div class="line">##### profile集合</div><div class="line"> * db.getProfilingStatus()</div><div class="line"> * db.setProfilingLevel(2)</div><div class="line"></div><div class="line"> * db.system.profile.find().sort(&#123;$natural:-1&#125;).limit(1)  </div><div class="line"> </div><div class="line">##### 日志</div><div class="line"> * mongodb.conf 中 verbose=vvvvv    v越多代表日志越详细</div><div class="line">  </div><div class="line">##### explain</div><div class="line">* db.collection.find(&#123;x:1&#125;).explain()</div><div class="line"></div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">## MongoDB 安全</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">###安全概览</div><div class="line">1. 最安全的是物理隔离：不现实</div><div class="line">2. 网络隔离其次</div><div class="line">3. 防火墙再其次</div><div class="line">4. 用户名密码在最后</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">#### 开启权限验证</div><div class="line">1. auth开启</div><div class="line">mongodb.conf 设置  auth=true;</div><div class="line"></div><div class="line">2. keyfile开启</div><div class="line"></div><div class="line">##### MongoDB创建用户</div><div class="line">1. 创建语法：createUser(2.6之前为addUser)</div><div class="line">2.</div></pre></td></tr></table></figure>
<p>{<br>user:”<name>“,<br>pwd:”<password>“,<br>sustomData:{&lt;说明&gt;},<br>roles;[{role:”<role>“,db:”database”}]<br>}<br>```</role></password></name></p>
<ol>
<li>角色类型：内建类型（read,readWrite,dbAdmin,dbOwner,userAdmin）</li>
</ol>
<h5 id="用户角色详解"><a href="#用户角色详解" class="headerlink" title="用户角色详解"></a>用户角色详解</h5><ol>
<li>数据库角色（read,readWrite,dbAdmin,dbOwner,userAdmin）</li>
<li>集群角色（cluterAdmin,clusterManager）</li>
<li>备份角色（backup,restore）</li>
<li>其他特殊权限（DBAdminAnyDatabase） </li>
</ol>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://clover.htmhub.com/hexoblog/2016/05/20/2016-05-2-monogo-db-study/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://clover.htmhub.com/hexoblog/2016/05/20/2016-05-2-monogo-db-study/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2017总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
